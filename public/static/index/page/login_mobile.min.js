var countdown=0;
function getCode(d){
    if(countdown!==0){
        return false
    }countdown=120;
    var c=/^1[3456789]\d{9}$/;
    var a=$("#phone").val();
    if(!c.test(a)){
        countdown=0;layMsg("手机号格式有误,请确认");
        return false
    }
    var b=U("Com/sendLoginCode");
    $.ajax({
        type:"post",
        url:b,
        data:{phone:a},
        dataType:"json",
        success:function(e){
            if(e.msg==="ok"){
                if(e.data==1){
                    layMsg("该手机号尚未绑定");
                    setTimeout(function(){
                        $(".cartoonflex>a:eq(1)").click()
                    },1000)
                }else{
                    settime(d)
                }
            }else{
                countdown=0;
                layMsg(e.msg)
            }
        },
        error:function(){
            countdown=0;
            layMsg("网络错误,请稍后再试")
        }
    })
}
function settime(a){
    if(countdown==0){
        $(a).text("发送验证码");
        return
    }else{
        $(a).text(countdown+"S");
        countdown--
    }
    setTimeout(function(){
        settime(a)},1000)
}
function doLogin(){
    var a=$("#phone").val();
    var c=$("#verify_code").val();
    var f=/^1[3456789]\d{9}$/;
    if(!f.test(a)){
        layMsg("手机号格式有误");return false
    }
    var e=/^\d{6}$/;if(!e.test(c)){
        layMsg("验证码有误");return false
    }
    var d={phone:a,code:c};
    var b=U("doLogin");
    ajaxPost(b,d,function(g){
        if(g.flag==22){
            layMsg("注册成功");
            setTimeout(function(){
                var h=U("User/index");
                window.location.href=h},1000)
        }else if(g.flag===0){
            layMsg("登陆成功");
            setTimeout(function(){
                var h=U("User/index");
                window.location.href=h},1000)
        }else {
            setTimeout(function(){
                var h=U("Center/index");
                window.location.href=h},1000)
        }
    })
}
$(function(){
    b();
    $(window).resize(function(){
        b()
    });
    function b(){
        var f=$("body").width();
        $(".cartoonWapper").width(f-20);
        $(".footer").width(f-60);
        $(".bootomDetele").width(f);
        var g=$(".cartoonflex>a.active").innerWidth(),
            d=$(".cartoonflex>a.active").offset().left,
            e=$(".cartoonflex").offset().left;
        $(".historyLine").css({"width":g,"left":d-e});
        var i=$(window).height(),
            h=$(".cartoonWapper").innerHeight();
        $(".wxLoginBg").height(i-h)
    }
    $(".cartoonflex>a").click(function(){
        var h=$(this),
            d=h.innerWidth(),
            g=$(".historyLine"),
            f=$(".cartoonflex").offset().left,
            e=$(this).offset().left;
        if(!h.hasClass("active")){
            h.addClass("active").siblings().removeClass("active");
            g.css({"width":d+50,"left":e-f});
            setTimeout(function(){g.width(d)},500)
        }else{
            g.css({"width":d,"left":e-f})}});
    var c=new Swiper(".swiper-history",{
        spaceBetween:0,autoHeight:true,observer:true,observeParents:true,
        on:{slideChangeTransitionStart:function(){
                $(".cartoonflex>a").removeClass("active");
                $(".cartoonflex>a").eq(this.activeIndex).addClass("active");
                b();
                if(this.activeIndex==1){
                    $(".select_sc").addClass("activeX")
                }else{
                    $(".select_sc").removeClass("activeX");
                    $(".bootomDetele").css("bottom",0);
                    $(".scBox").css("marginLeft",0);
                    $(".select_sc").text("选择")
                }
            }
        }
    });
    $(".cartoonflex>a").click(function(){
        var d=$(".cartoonflex>a").index($(this));
        $(this).addClass("active").siblings().removeClass("active");
        c.slideTo(d,1000,false)
    });
    if(code){
        setInterval(a,2000)
    }
    function a(){
        var d=U("checkQrLogin");
        $.ajax(
            {type:"post",url:d,data:{code:code},dataType:"json",
                success:function(e){
                    if(e.msg==="ok"&&e.data.url){
                        window.location.href=e.data.url
                    }
            }
            })
    }});