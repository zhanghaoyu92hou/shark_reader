var page = 1,
is_end = false,
cur_chapter = 1;
function chapterPlay(f, d) {
    if (!$(d).hasClass("active")) {
        var e = $(d).attr("data-src");
        if (!e) {
            var c = U("checkMusicChapter");
            postRes(c, {
                book_id: book_id,
                number: f
            },
            function(i) {
                switch (i.flag) {
                case 0:
                    layMsg("音频加载中...");
                    cur_chapter = f;
                    $(d).attr("data-src", i.url);
                    var g = '<audio id="MusicAudio"  preload="auto" controls><source src="' + i.url + '" type="audio/mpeg"/></audio>';
                    $(".MusicCenter").html(g);
                    $(".Music").show();
                    $("#MusicAudio").audioPlayer();
                    $(".directory_two .active").children("img").attr("src", "/static/index/images/play.png");
                    $(".directory_two .active").removeClass("active");
                    $(d).addClass("active");
                    $(d).children("img").attr("src", "/static/index/images/pause_orange.png");
                    var h = $(d).find("em").text();
                    $(".bfAudio").find("em").text(h);
                    $(".bfAudio").addClass("active");
                    $(".bfAudio").children("img").attr("src", "/static/index/images/play_w.png");
                    $(".bfAudio").children("img").addClass("active");
                    $("#MusicAudio")[0].play();
                    $(".audioplayer-playpause").addClass("audioplayer-playpause2");
                    break;
                case 1:
                    layer.open({
                        content:
                        i.msg,
                        btn: ["确定", "取消"],
                        yes: function(j) {
                            layer.close(j);
                            window.location.href = i.url
                        }
                    });
                    return false;
                    break;
                case 2:
                    layer.open({
                        content:
                        "您的书币余额不足，是否立即充值?",
                        btn: ["确定", "取消"],
                        yes: function(j) {
                            layer.close(j);
                            window.location.href = i.url
                        }
                    });
                    return false;
                    break;
                case 3:
                    layer.open({
                        content:
                        i.msg,
                        btn: ["确定", "取消"],
                        yes: function(j) {
                            layer.close(j);
                            postRes(c, {
                                book_id: book_id,
                                number: f,
                                is_confirm: "yes"
                            },
                            function(m) {
                                if (m.flag !== 0) {
                                    layMsg("访问异常,请重试");
                                    return false
                                }
                                layMsg("音频加载中...");
                                cur_chapter = f;
                                $(d).attr("data-src", m.url);
                                var k = '<audio id="MusicAudio"  preload="auto" controls><source src="' + m.url + '" type="audio/mpeg"/></audio>';
                                $(".MusicCenter").html(k);
                                $(".Music").show();
                                $("#MusicAudio").audioPlayer();
                                $(".directory_two .active").children("img").attr("src", "/static/index/images/play.png");
                                $(".directory_two .active").removeClass("active");
                                $(d).addClass("active");
                                $(d).children("img").attr("src", "/static/index/images/pause_orange.png");
                                var l = $(d).find("em").text();
                                $(".bfAudio").find("em").text(l);
                                $(".bfAudio").addClass("active");
                                $(".bfAudio").children("img").attr("src", "/static/index/images/play_w.png");
                                $(".bfAudio").children("img").addClass("active");
                                $("#MusicAudio")[0].play();
                                $(".audioplayer-playpause").addClass("audioplayer-playpause2")
                            })
                        }
                    });
                    break
                }
            })
        } else {
            if (f !== cur_chapter) {
                var a = '<audio id="MusicAudio"  preload="auto" controls><source src="' + e + '" type="audio/mpeg"/></audio>';
                $(".MusicCenter").html(a);
                $(".Music").show();
                $("#MusicAudio").audioPlayer()
            }
            $(".directory_two .active").children("img").attr("src", "/static/index/images/play.png");
            $(".directory_two .active").removeClass("active");
            $(d).addClass("active");
            $(d).children("img").attr("src", "/static/index/images/pause_orange.png");
            var b = $(d).find("em").text();
            $(".bfAudio").find("em").text(b);
            $(".bfAudio").addClass("active");
            $(".bfAudio").children("img").attr("src", "/static/index/images/play_w.png");
            $(".bfAudio").children("img").addClass("active");
            $("#MusicAudio")[0].play();
            $(".audioplayer-playpause").addClass("audioplayer-playpause2")
        }
    } else {
        $(d).removeClass("active");
        $(d).children("img").attr("src", "/static/index/images/play.png");
        $(".bfAudio").removeClass("active");
        $(".bfAudio").children("img").removeClass("active");
        $(".bfAudio").children("img").attr("src", "/static/index/images/pause_w.png");
        $("#MusicAudio")[0].pause();
        $(".audioplayer-playpause").removeClass("audioplayer-playpause2")
    }
}
function buttonPlay(d) {
    $(".directoryNav>a:eq(1)").click();
    var b = $(d).children("img");
    var c = $('a[data-number="' + cur_chapter + '"]');
    if (!$(d).hasClass("active")) {
        var e = c.attr("data-src");
        if (e) {
            $(d).addClass("active");
            b.addClass("active");
            b.attr("src", "/static/index/images/play_w.png");
            c.addClass("active");
            c.children("img").attr("src", "/static/index/images/pause_orange.png");
            $("#MusicAudio")[0].play();
            $(".audioplayer-playpause").addClass("audioplayer-playpause2")
        } else {
            var a = U("checkMusicChapter");
            postRes(a, {
                book_id: book_id,
                number: cur_chapter
            },
            function(g) {
                switch (g.flag) {
                case 0:
                    layMsg("音频加载中...");
                    c.attr("data-src", g.url);
                    var f = '<audio id="MusicAudio"  preload="auto" controls><source src="' + g.url + '" type="audio/mpeg"/></audio>';
                    $(".MusicCenter").html(f);
                    $(".Music").show();
                    $("#MusicAudio").audioPlayer();
                    $(".directory_two .active").children("img").attr("src", "/static/index/images/play.png");
                    $(".directory_two .active").removeClass("active");
                    c.addClass("active");
                    c.children("img").attr("src", "/static/index/images/pause_orange.png");
                    $(d).addClass("active");
                    $(d).children("img").attr("src", "/static/index/images/play_w.png");
                    $(d).children("img").addClass("active");
                    $("#MusicAudio")[0].play();
                    $(".audioplayer-playpause").addClass("audioplayer-playpause2");
                    break;
                case 1:
                    layer.open({
                        content:
                        g.msg,
                        btn: ["确定", "取消"],
                        yes: function(h) {
                            layer.close(h);
                            window.location.href = g.url
                        }
                    });
                    return false;
                    break;
                case 2:
                    layer.open({
                        content:
                        "您的书币余额不足，是否立即充值?",
                        btn: ["确定", "取消"],
                        yes: function(h) {
                            layer.close(h);
                            window.location.href = g.url
                        }
                    });
                    return false;
                    break;
                case 3:
                    layer.open({
                        content:
                        g.msg,
                        btn: ["确定", "取消"],
                        yes: function(h) {
                            layer.close(h);
                            postRes(a, {
                                book_id: book_id,
                                number: $number,
                                is_confirm: "yes"
                            },
                            function(j) {
                                if (j.flag !== 0) {
                                    layMsg("访问异常,请重试");
                                    return false
                                }
                                layMsg("音频加载中...");
                                c.attr("data-src", j.url);
                                var i = '<audio id="MusicAudio"  preload="auto" controls><source src="' + j.url + '" type="audio/mpeg"/></audio>';
                                $(".MusicCenter").html(i);
                                $(".Music").show();
                                $("#MusicAudio").audioPlayer();
                                $(".directory_two .active").children("img").attr("src", "/static/index/images/play.png");
                                $(".directory_two .active").removeClass("active");
                                c.addClass("active");
                                c.children("img").attr("src", "/static/index/images/pause_orange.png");
                                $(d).addClass("active");
                                $(d).children("img").attr("src", "/static/index/images/play_w.png");
                                $(d).children("img").addClass("active");
                                $("#MusicAudio")[0].play();
                                $(".audioplayer-playpause").addClass("audioplayer-playpause2")
                            })
                        }
                    });
                    break
                }
            })
        }
    } else {
        $(d).removeClass("active");
        b.removeClass("active");
        c.removeClass("active");
        c.children("img").attr("src", "/static/index/images/play.png");
        b.attr("src", "/static/index/images/pause_w.png");
        $("#MusicAudio")[0].pause();
        $(".audioplayer-playpause").removeClass("audioplayer-playpause2")
    }
}
$(function() {
    getSameBooks();
    checkCollect();
    getComments();
    getChapters();
    a();
    $(window).resize(function() {
        a()
    });
    function a() {
        var c = $("body").width();
        $(".footerBook").width(c)
    }
    var b = new Swiper(".swiperBook", {
        spaceBetween: 0,
        autoHeight: true,
        observer: true,
        observeParents: true,
    });
    $(".directoryNav>a").click(function() {
        var c = $(".directoryNav>a").index($(this));
        $(this).addClass("active").siblings().removeClass("active");
        b.slideTo(c, 1000, false)
    })
});
function rewardLayer() {
    layer.open({
        content: $(".ds_proup").html(),
        shadeClose: false,
        className: "layerPadding",
        style: "background-color:#fff; color:#fff; border:none;"
    })
}
function chooseRewardMoney(a) {
    $(a).addClass("active").siblings().removeClass("active")
}
function doReward() {
    var b = $(".layerPadding .reward_money .active").attr("data-val");
    var c = {
        money: b,
        relation_id: book_id,
        relation_type: book_type
    };
    var a = U("Charge/doReward");
    if (a) {
        ajaxPost(a, c,
        function(d) {
            window.location.href = d.url
        })
    }
}
function doCollect(b) {
    if (!$(b).hasClass("active_sc")) {
        var a = U("Com/doCollect");
        if (a) {
            ajaxPost(a, {
                book_id: book_id
            },
            function() {
                layMsg("收藏成功");
                $(b).addClass("active_sc")
            })
        }
    }
}
function checkCollect() {
    var a = U("Com/doCheckCollect");
    if (a) {
        ajaxPost(a, {
            book_id: book_id
        },
        function(b) {
            if (b.flag === 1) {
                $(".book-collect").addClass("active_sc")
            }
        })
    }
}
function getRewardMoney() {
    var a = U("getRewardMoney");
    if (a) {
        ajaxPost(a, {
            book_id: book_id
        },
        function(b) {
            var c = "本书已收到<em>" + b.money + "</em>元打赏，共" + b.people + "人打赏";
            $("#reward-str").html(c)
        })
    }
}
function getSameBooks() {
    var a = U("getSameBooks");
    ajaxPost(a, {
        book_id: book_id
    },
    function(c) {
        if (c.list) {
            var b = U("info");
            var d = "";
            $.each(c.list,
            function(e, f) {
                d += "<li>";
                d += '<a href="' + b + "?book_id=" + f.id + '">';
                d += "<div>";
                d += '<img src="' + f.cover + '">';
                d += "</div>";
                d += "<h4>" + f.name + "</h4>";
                d += "</a>";
                d += "</li>"
            });
            if (d) {
                $(".choicenessCount>ul").html(d);
                $(".evaluation").show()
            }
        }
    })
}
function getComments() {
    var a = U("Com/getComments");
    if (a) {
        ajaxPost(a, {
            pid: book_id,
            ptype: book_type
        },
        function(b) {
            if (b.list) {
                var c = "";
                $.each(b.list,
                function(d, e) {
                    c += "<li>";
                    c += '<div class="evaluationImg">';
                    c += '<img src="' + e.headimgurl + '" alt="">';
                    c += "</div>";
                    c += '<div class="evaluationFont">';
                    c += "<div>";
                    c += "<h4>" + e.nickname + "</h4>";
                    c += "<span>2019-09-27</span>";
                    c += "</div>";
                    c += "<p>" + e.content + "</p>";
                    c += "</div>";
                    c += "</li>"
                });
                $(".evaluationList>ul").html(c)
            } else {
                $(".evaluationList>ul").html('<li style="text-align:center;font-size:1.3rem;">暂无评论</li>')
            }
            $("#commentNum").text("(" + b.count + ")")
        })
    }
}
function getChapters() {
    if (!is_end) {
        is_end = true;
        var a = U("getBookChapter");
        if (a) {
            ajaxPost(a, {
                book_id: book_id,
                page: page
            },
            function(c) {
                var b = 0;
                if (c) {
                    $.each(c,
                    function(d, e) {
                        b++;
                        var f = "";
                        if (e.money > 0) {
                            f += '<a href="javascript:;" data-src="" data-number="' + e.number + '" onclick="javascript:chapterPlay(' + e.number + ',this);">';
                            f += '<img src="/static/index/images/play.png" alt="">';
                            f += "<em>" + e.name + "</em>";
                            f += "<p>";
                            f += '<img src="/static/index/images/shub.jpg" alt="">';
                            f += "<i>" + e.money + "书币</i>";
                            f += "</p>";
                            f += "</a>"
                        } else {
                            f += '<a href="javascript:;" data-src="" data-number="' + e.number + '" onclick="javascript:chapterPlay(' + e.number + ',this);">';
                            f += '<img src="/static/index/images/play.png" alt="">';
                            f += "<em>" + e.name + "</em>";
                            f += "</a>"
                        }
                        $(".directory_two").append(f)
                    })
                }
                if (b < 12) {
                    $(".lookMore>a").text("...我也是有底线的...")
                } else {
                    page++;
                    is_end = false
                }
            })
        }
    }
};