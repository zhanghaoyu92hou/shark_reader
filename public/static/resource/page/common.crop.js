var is_upload=false;var image=document.querySelector("#crop_image");var options={aspectRatio:$crop_ratio,ready:function(){var a=this.cloneNode();a.className="";a.style.cssText=("display: block;"+"width: 100%;"+"min-width: 0;"+"min-height: 0;"+"max-width: none;"+"max-height: none;")}};var cropper=new Cropper(image,options);layui.use(["upload"],function(){var a=layui.upload;a.render({elem:"#doChoose",accept:"images",exts:"jpg|jpeg|png",size:5000,drag:false,auto:false,choose:function(b){b.preview(function(d,e,c){if(/^image\/\w+/.test(e.type)){image.src=c;cropper.destroy();cropper=new Cropper(image,options)}else{layError("图片格式有误")}})}})});function uploadImage(a){if(is_upload){layError("文件正在上传中");return false}is_upload=true;layui.use(["jquery","layer"],function(){var e=layui.jquery,c=layui.layer,g;var d=cropper.getCroppedCanvas({width:$crop_width,height:$crop_height});if(!d){layError("请选择要裁剪的图片");is_upload=false;return false}var b=d.toDataURL("image/jpg");var f=b.replace(/^data:image\/(png|jpg|jpeg);base64,/,"");g=c.load(2,{shade:[0.5,"#000"],content:"图片上传中...",success:function(h){h.find(".layui-layer-content").css({"padding-left":"39px","width":"100px","line-height":"32px","color":"#fff"})}});e.ajax({type:"post",url:window.location.href,data:{img:f},dataType:"json",success:function(h){is_upload=false;c.close(g);if(h.code===1){a(h.data.url)}else{layError(h.msg)}},error:function(){is_upload=false;c.close(g);layError("网络出错");return false}})})};